<!DOCTYPE html>
<html>
<head>
<style>
  :root {
    --bg: #fafafa;
    --surface: #ffffff;
    --primary: #2563eb;
    --primary-hover: #1d4ed8;
    --text: #27272a;
    --text-secondary: #71717a;
    --border: #e4e4e7;
    --error: #ef4444;
    --radius: 8px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: Inter, system-ui, -apple-system, sans-serif;
    font-size: 14px;
    color: var(--text);
    background: var(--surface);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }

  .logo {
    width: 40px;
    height: 40px;
    background: #18181b;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .logo svg { width: 24px; height: 24px; }

  .header-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    flex: 1;
  }

  .icon-btn {
    width: 40px;
    height: 40px;
    border: none;
    background: transparent;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
  }

  .icon-btn:hover {
    background: var(--bg);
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 4px;
    padding: 0 16px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }

  .tab {
    position: relative;
    padding: 12px 16px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
  }

  .tab:hover {
    color: var(--text);
  }

  .tab.active {
    color: var(--text);
    border-bottom-color: var(--primary);
  }

  .tab-badge {
    position: absolute;
    top: 6px;
    right: 2px;
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    background: var(--primary);
    color: white;
    font-size: 11px;
    font-weight: 600;
    border-radius: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Content */
  .content {
    flex: 1;
    overflow-y: auto;
    background: var(--bg);
  }

  .tab-content {
    display: none;
    height: 100%;
  }

  .tab-content.active {
    display: flex;
    flex-direction: column;
  }

  /* Intro States */
  .intro-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 40px 20px;
    text-align: center;
  }

  .intro-icon {
    width: 48px;
    height: 48px;
    margin-bottom: 20px;
    stroke: var(--text);
    stroke-width: 2;
  }

  .intro-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 6px;
  }

  .intro-subtitle {
    font-size: 14px;
    color: var(--text-secondary);
  }

  .component-icon {
    width: 80px;
    height: 80px;
    margin-bottom: 20px;
    stroke: var(--text);
    stroke-width: 1.5;
  }

  .selected-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: #f0fdf4;
    color: #16a34a;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    margin: 16px 0 32px;
  }

  .selected-badge svg {
    width: 16px;
    height: 16px;
  }

  .btn-primary {
    padding: 14px 40px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-primary:hover {
    background: var(--primary-hover);
  }

  .btn-primary svg {
    width: 18px;
    height: 18px;
  }

  /* Loading */
  .loading-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 10px;
  }

  .loading-subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 32px;
  }

  .progress-bar {
    width: 100%;
    max-width: 340px;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--primary);
    transition: width 0.3s ease;
  }

  /* Results */
  .results {
    padding: 24px;
  }

  .results-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 24px;
  }

  .section {
    background: white;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 12px;
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    cursor: pointer;
    user-select: none;
  }

  .section-badge {
    min-width: 24px;
    height: 24px;
    padding: 0 8px;
    background: var(--primary);
    color: white;
    font-size: 12px;
    font-weight: 600;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .section-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
    flex: 1;
  }

  .section-chevron {
    width: 20px;
    height: 20px;
    stroke: var(--text-secondary);
    transition: transform 0.2s;
  }

  .section-header.collapsed .section-chevron {
    transform: rotate(-90deg);
  }

  .section-body {
    border-top: 1px solid var(--border);
    overflow: hidden;
  }

  .section-body.collapsed {
    display: none;
  }

  .issue-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.15s;
  }

  .issue-item:last-child {
    border-bottom: none;
  }

  .issue-item:hover {
    background: var(--bg);
  }

  .issue-icon {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    stroke: var(--error);
  }

  .issue-text {
    flex: 1;
    min-width: 0;
  }

  .issue-label {
    font-size: 14px;
    color: var(--text-secondary);
  }

  .issue-name {
    font-size: 14px;
    font-weight: 500;
    color: var(--error);
  }

  .fix-all-btn {
    width: 100%;
    padding: 16px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 0 0 var(--radius) var(--radius);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
  }

  .fix-all-btn:hover {
    background: var(--primary-hover);
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="logo">
    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
      <polyline points="14 2 14 8 20 8"/>
      <line x1="16" y1="13" x2="8" y2="13"/>
      <line x1="16" y1="17" x2="8" y2="17"/>
      <polyline points="10 9 9 9 8 9"/>
    </svg>
  </div>
  <span class="header-title">CLOS-UI</span>
  <a class="icon-btn" href="https://equal-level-26092821.figma.site/" target="_blank" title="Help">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/>
      <line x1="12" y1="17" x2="12.01" y2="17"/>
    </svg>
  </a>
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tab active" data-tab="properties">
    Properties
    <span class="tab-badge" id="badge-properties" style="display: none;"></span>
  </div>
  <div class="tab" data-tab="hierarchy">
    Hierarchy
    <span class="tab-badge" id="badge-hierarchy" style="display: none;"></span>
  </div>
  <div class="tab" data-tab="layers">
    Layers
    <span class="tab-badge" id="badge-layers" style="display: none;"></span>
  </div>
  <div class="tab" data-tab="variables">
    Variables
    <span class="tab-badge" id="badge-variables" style="display: none;"></span>
  </div>
</div>

<!-- Content -->
<div class="content">

  <!-- Properties Tab -->
  <div class="tab-content active" id="tab-properties">
    <div class="intro-state" id="properties-empty">
      <svg class="intro-icon" viewBox="0 0 24 24" fill="none">
        <rect x="3" y="3" width="18" height="18" rx="2" stroke-dasharray="4 2"/>
        <line x1="12" y1="9" x2="12" y2="15"/>
        <line x1="9" y1="12" x2="15" y2="12"/>
      </svg>
      <div class="intro-title">Select a frame</div>
      <div class="intro-subtitle">or component</div>
    </div>

    <div class="intro-state" id="properties-selected" style="display: none;">
      <svg class="component-icon" viewBox="0 0 24 24" fill="none">
        <rect x="7" y="7" width="4" height="4" rx="0.5" transform="rotate(45 9 9)"/>
        <rect x="13" y="7" width="4" height="4" rx="0.5" transform="rotate(45 15 9)"/>
        <rect x="7" y="13" width="4" height="4" rx="0.5" transform="rotate(45 9 15)"/>
        <rect x="13" y="13" width="4" height="4" rx="0.5" transform="rotate(45 15 15)"/>
      </svg>
      <div class="intro-title" id="properties-name">Component Name</div>
      <div class="selected-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
          <path d="M20 6L9 17l-5-5"/>
        </svg>
        Selected
      </div>
      <button class="btn-primary" id="btn-check-properties">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        Check Design
      </button>
    </div>

    <div class="intro-state" id="properties-loading" style="display: none;">
      <div class="loading-title">Checking Your Components</div>
      <div class="loading-subtitle">Scanning design elements..</div>
      <div class="progress-bar">
        <div class="progress-fill" id="properties-progress" style="width: 0%"></div>
      </div>
    </div>

    <div class="results" id="properties-results" style="display: none;"></div>
  </div>

  <!-- Hierarchy Tab -->
  <div class="tab-content" id="tab-hierarchy">
    <div class="intro-state" id="hierarchy-empty">
      <svg class="intro-icon" viewBox="0 0 24 24" fill="none">
        <rect x="3" y="3" width="18" height="18" rx="2" stroke-dasharray="4 2"/>
        <line x1="12" y1="9" x2="12" y2="15"/>
        <line x1="9" y1="12" x2="15" y2="12"/>
      </svg>
      <div class="intro-title">Select a frame</div>
      <div class="intro-subtitle">or component</div>
    </div>

    <div class="intro-state" id="hierarchy-selected" style="display: none;">
      <svg class="component-icon" viewBox="0 0 24 24" fill="none">
        <rect x="7" y="7" width="4" height="4" rx="0.5" transform="rotate(45 9 9)"/>
        <rect x="13" y="7" width="4" height="4" rx="0.5" transform="rotate(45 15 9)"/>
        <rect x="7" y="13" width="4" height="4" rx="0.5" transform="rotate(45 9 15)"/>
        <rect x="13" y="13" width="4" height="4" rx="0.5" transform="rotate(45 15 15)"/>
      </svg>
      <div class="intro-title" id="hierarchy-name">Component Name</div>
      <div class="selected-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
          <path d="M20 6L9 17l-5-5"/>
        </svg>
        Selected
      </div>
      <button class="btn-primary" id="btn-check-hierarchy">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        Check Design
      </button>
    </div>

    <div class="intro-state" id="hierarchy-loading" style="display: none;">
      <div class="loading-title">Checking Your Components</div>
      <div class="loading-subtitle">Scanning design elements..</div>
      <div class="progress-bar">
        <div class="progress-fill" id="hierarchy-progress" style="width: 0%"></div>
      </div>
    </div>

    <div class="results" id="hierarchy-results" style="display: none;"></div>
  </div>

  <!-- Layers Tab -->
  <div class="tab-content" id="tab-layers">
    <div class="intro-state" id="layers-empty">
      <svg class="intro-icon" viewBox="0 0 24 24" fill="none">
        <rect x="3" y="3" width="18" height="18" rx="2" stroke-dasharray="4 2"/>
        <line x1="12" y1="9" x2="12" y2="15"/>
        <line x1="9" y1="12" x2="15" y2="12"/>
      </svg>
      <div class="intro-title">Select a frame</div>
      <div class="intro-subtitle">or component</div>
    </div>

    <div class="intro-state" id="layers-selected" style="display: none;">
      <svg class="component-icon" viewBox="0 0 24 24" fill="none">
        <rect x="7" y="7" width="4" height="4" rx="0.5" transform="rotate(45 9 9)"/>
        <rect x="13" y="7" width="4" height="4" rx="0.5" transform="rotate(45 15 9)"/>
        <rect x="7" y="13" width="4" height="4" rx="0.5" transform="rotate(45 9 15)"/>
        <rect x="13" y="13" width="4" height="4" rx="0.5" transform="rotate(45 15 15)"/>
      </svg>
      <div class="intro-title" id="layers-name">Component Name</div>
      <div class="selected-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
          <path d="M20 6L9 17l-5-5"/>
        </svg>
        Selected
      </div>
      <button class="btn-primary" id="btn-check-layers">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        Check Design
      </button>
    </div>

    <div class="intro-state" id="layers-loading" style="display: none;">
      <div class="loading-title">Checking Your Components</div>
      <div class="loading-subtitle">Scanning design elements..</div>
      <div class="progress-bar">
        <div class="progress-fill" id="layers-progress" style="width: 0%"></div>
      </div>
    </div>

    <div class="results" id="layers-results" style="display: none;"></div>
  </div>

  <!-- Variables Tab -->
  <div class="tab-content" id="tab-variables">
    <div class="intro-state" id="variables-empty">
      <svg class="intro-icon" viewBox="0 0 24 24" fill="none">
        <rect x="3" y="3" width="18" height="18" rx="2" stroke-dasharray="4 2"/>
        <line x1="12" y1="9" x2="12" y2="15"/>
        <line x1="9" y1="12" x2="15" y2="12"/>
      </svg>
      <div class="intro-title">Select a frame</div>
      <div class="intro-subtitle">or component</div>
    </div>

    <div class="intro-state" id="variables-selected" style="display: none;">
      <svg class="component-icon" viewBox="0 0 24 24" fill="none">
        <rect x="7" y="7" width="4" height="4" rx="0.5" transform="rotate(45 9 9)"/>
        <rect x="13" y="7" width="4" height="4" rx="0.5" transform="rotate(45 15 9)"/>
        <rect x="7" y="13" width="4" height="4" rx="0.5" transform="rotate(45 9 15)"/>
        <rect x="13" y="13" width="4" height="4" rx="0.5" transform="rotate(45 15 15)"/>
      </svg>
      <div class="intro-title" id="variables-name">Component Name</div>
      <div class="selected-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
          <path d="M20 6L9 17l-5-5"/>
        </svg>
        Selected
      </div>
      <button class="btn-primary" id="btn-check-variables">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        Check Design
      </button>
    </div>

    <div class="intro-state" id="variables-loading" style="display: none;">
      <div class="loading-title">Checking Your Components</div>
      <div class="loading-subtitle">Scanning design elements..</div>
      <div class="progress-bar">
        <div class="progress-fill" id="variables-progress" style="width: 0%"></div>
      </div>
    </div>

    <div class="results" id="variables-results" style="display: none;"></div>
  </div>

</div>

<script>
  // Tab switching
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.dataset.tab;
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(tc => tc.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
    });
  });

  // Handle selection changes
  onmessage = (event) => {
    const msg = event.data.pluginMessage;

    if (msg.type === 'selection-changed') {
      updateAllTabsSelection(msg);
    } else if (msg.type === 'progress') {
      updateProgress(msg);
    } else if (msg.type === 'properties-results') {
      showResults('properties', msg);
    } else if (msg.type === 'hierarchy-results') {
      showResults('hierarchy', msg);
    } else if (msg.type === 'layers-results') {
      showResults('layers', msg);
    } else if (msg.type === 'variables-results') {
      showResults('variables', msg);
    }
  };

  function updateAllTabsSelection(msg) {
    ['properties', 'hierarchy', 'layers', 'variables'].forEach(tab => {
      const empty = document.getElementById(`${tab}-empty`);
      const selected = document.getElementById(`${tab}-selected`);
      const nameEl = document.getElementById(`${tab}-name`);

      if (msg.hasSelection) {
        empty.style.display = 'none';
        selected.style.display = 'flex';
        if (nameEl) nameEl.textContent = msg.name;
      } else {
        empty.style.display = 'flex';
        selected.style.display = 'none';
      }
    });
  }

  function updateProgress(msg) {
    const activeTab = document.querySelector('.tab.active').dataset.tab;
    const progressBar = document.getElementById(`${activeTab}-progress`);
    if (progressBar) {
      progressBar.style.width = msg.percent + '%';
    }
  }

  // Check Design buttons
  ['properties', 'hierarchy', 'layers', 'variables'].forEach(tab => {
    document.getElementById(`btn-check-${tab}`).addEventListener('click', () => {
      showLoading(tab);
      parent.postMessage({ pluginMessage: { type: `scan-${tab}` } }, '*');
    });
  });

  function showLoading(tab) {
    document.getElementById(`${tab}-selected`).style.display = 'none';
    document.getElementById(`${tab}-loading`).style.display = 'flex';
    document.getElementById(`${tab}-results`).style.display = 'none';
  }

  function showResults(tab, msg) {
    document.getElementById(`${tab}-loading`).style.display = 'none';
    const resultsEl = document.getElementById(`${tab}-results`);
    resultsEl.style.display = 'block';

    if (!msg.issues || msg.issues.length === 0) {
      resultsEl.innerHTML = '<div style="text-align:center;padding:60px 20px;color:#16a34a;font-weight:600;">All Clear!</div>';
      return;
    }

    let html = '<div class="results-title">Review Issues</div>';

    msg.issues.forEach(section => {
      html += `
        <div class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <span class="section-badge">${section.count}</span>
            <span class="section-title">${section.title}</span>
            <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </div>
          <div class="section-body">
            ${section.items.map(item => `
              <div class="issue-item" onclick="selectNode('${item.id}')">
                <svg class="issue-icon" viewBox="0 0 24 24" fill="none" stroke-width="2">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                  <line x1="12" y1="9" x2="12" y2="13"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <div class="issue-text">
                  <div class="issue-label">${item.label}:</div>
                  <div class="issue-name">${item.name}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    });

    resultsEl.innerHTML = html;

    // Update badge
    const badge = document.getElementById(`badge-${tab}`);
    badge.textContent = msg.issues.reduce((sum, s) => sum + s.count, 0);
    badge.style.display = 'flex';
  }

  function toggleSection(header) {
    header.classList.toggle('collapsed');
    const body = header.nextElementSibling;
    if (body) body.classList.toggle('collapsed');
  }

  function selectNode(nodeId) {
    parent.postMessage({ pluginMessage: { type: 'select-node', nodeId } }, '*');
  }
</script>

</body>
</html>
